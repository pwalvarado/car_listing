<h1><%= @listing.name %></h1>

<h3><%= @listing.title %></h3>

<section class="top-info clear-fix">
  <section class="pics">
  <% if @listing.pics.empty? %>
    <p>Sorry, no pics :(</p>
  <% else %>
    <div class="main-pic">
      <%= image_tag @listing.main_pic.file.url, class: "car-pic" %>
    </div>
    <ul class="thumbs clear-fix">
      <% @listing.pics.each do |thumb| %>
      <li><%= image_tag thumb.file.url, class: "car-pic" %></li>
      <% end %>
    </ul>
  <% end %>
  </section>


  <section class="info">
    <article class="car-info">
      <header>What it is:</header>

      <ul>
        <li>
          <label>Year:</label>
          <span><%= @listing.year %></span>
        </li>
        <li>
          <label>Make:</label>
          <span><%= @listing.make.name %></span>
        </li>
        <li>
          <label>Model:</label>
          <span><%= @listing.model.name %></span>
        </li>
        <li>
          <label>Seller:</label>
          <span><%= @listing.is_owner ? "OWNER" : "DEALER" %></span>
        </li>
        <li>
          <label>Contact:</label>
          <span><%= number_to_phone(@listing.phone) %></span>
        </li>
        <li>
          <label>Asking:</label>
          <span><%= number_to_currency(@listing.price, precision: 0) %></span>
        </li>
      </ul>
    </article>
  </section>
</section>

<section class="description">
  <h2>Seller Description</h2>
  <p><%= @listing.description %></p>
</section>



<script>
$(document).ready(function() {
  var $lightbox = $("div.lightbox");
  var totalPics = <%= @listing.pics.count %>;
  currentPic = 1;

  var width = <%= @listing.pics.count * 600 %>
  $("div.viewport > ul").css("width", width);
  <% @listing.pics.each do |pic| %>
    $("div.lightbox ul").append('<li><%= image_tag pic.file.url %></li>');
  <% end %>

  $("img.car-pic").click(function() {
    $("body").toggleClass("no-scroll");
    $lightbox.toggleClass("show");
    setViewportCSS();
  });

  function setViewportCSS() {
    var imgHeight = $($("div.viewport > ul > li > img")[currentPic-1]).css("height");

    $("div.viewport").css("height", imgHeight);

    $("div.viewport").css("margin", function() {
      var viewPortHeight = parseInt($("div.viewport").css("height"));
      var newMargin = (viewPortHeight - imgHeight)/2;
      if (newMargin > 0) { newMargin = 0 }

      return "" + newMargin + "px auto";
    });
  };


  $(window).keydown(function(event) {
    if (event.keyCode == 27) { // ESC pressed
      $lightbox.removeClass("show");
      $("body").toggleClass("no-scroll");
    }
    else if (event.keyCode == 37 && currentPic > 1 && $lightbox.hasClass("show")) {
      currentPic--;
      $("div.viewport > ul").css("left", function(i, val) {
        return ""+(parseInt(val) + 600)+"px";
      });

      setViewportCSS();
    }
    else if (event.keyCode == 39 && currentPic < totalPics && $lightbox.hasClass("show")) {
      currentPic++;
      $("div.viewport > ul").css("left", function(i, val) {
        return ""+(parseInt(val) - 600)+"px";
      });

      setViewportCSS();
    }
  });
});
</script>



